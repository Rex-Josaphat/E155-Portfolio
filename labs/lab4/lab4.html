<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.21">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>E155 Lab 4: Digital Audio – E155 Portfolio</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-ea1d7ac60288e0f1efdbc993fd8432ae.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-e31584831b205ffbb2d98406f31c2a5b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link rel="icon" href="images/JN_Icon.ico" type="image/x-icon">


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">E155 Portfolio</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-e155-labs" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">E155 Labs</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-e155-labs">    
        <li>
    <a class="dropdown-item" href="../../labs/lab1/lab1.html">
 <span class="dropdown-text">Lab 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab2/lab2.html">
 <span class="dropdown-text">Lab 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab3/lab3.html">
 <span class="dropdown-text">Lab 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab4/lab4.html">
 <span class="dropdown-text">Lab 4</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab5/lab5.html">
 <span class="dropdown-text">Lab 5</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab6/lab6.html">
 <span class="dropdown-text">Lab 6</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab7/lab7.html">
 <span class="dropdown-text">Lab 7</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-final-project" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Final Project</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-final-project">    
        <li>
    <a class="dropdown-item" href="../../finalProject/proposal.html">
 <span class="dropdown-text">Project Proposal</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="https://hmc-e155.github.io/"> 
<span class="menu-text">Resources</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/Rex-Josaphat" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#experiment-setup-and-design-overview" id="toc-experiment-setup-and-design-overview" class="nav-link" data-scroll-target="#experiment-setup-and-design-overview">Experiment Setup and Design Overview</a>
  <ul class="collapse">
  <li><a href="#mcu-setup-logic" id="toc-mcu-setup-logic" class="nav-link" data-scroll-target="#mcu-setup-logic">MCU Setup Logic</a></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation">Implementation</a></li>
  </ul></li>
  <li><a href="#verification-of-timer-limits-and-edge-cases" id="toc-verification-of-timer-limits-and-edge-cases" class="nav-link" data-scroll-target="#verification-of-timer-limits-and-edge-cases">Verification of Timer Limits and Edge Cases</a>
  <ul class="collapse">
  <li><a href="#delay-limits" id="toc-delay-limits" class="nav-link" data-scroll-target="#delay-limits">Delay Limits</a></li>
  <li><a href="#pwm-frequency-limits" id="toc-pwm-frequency-limits" class="nav-link" data-scroll-target="#pwm-frequency-limits">PWM Frequency Limits</a></li>
  <li><a href="#song-playing-accuracy" id="toc-song-playing-accuracy" class="nav-link" data-scroll-target="#song-playing-accuracy">Song Playing Accuracy</a></li>
  </ul></li>
  <li><a href="#hardware-testing-and-results" id="toc-hardware-testing-and-results" class="nav-link" data-scroll-target="#hardware-testing-and-results">Hardware Testing and Results</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#ai-prototype-summary" id="toc-ai-prototype-summary" class="nav-link" data-scroll-target="#ai-prototype-summary">AI Prototype Summary</a></li>
  </ul>
<div class="quarto-other-links"><h2>Other Links</h2><ul><li><a href="https://hmc-e155.github.io/lab/lab4/"><i class="bi bi-info-circle"></i>Lab 4 Class Overview</a></li></ul></div><div class="quarto-code-links"><h2>Code Links</h2><ul><li><a href="https://github.com/Rex-Josaphat/E155-LAB4"><i class="bi bi-github"></i>Lab 4 Repository</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">E155 Lab 4: Digital Audio</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In this lab the STM32L432KC Microcontroller Unit (MCU) was used to play music on a speaker. The MCU did this by generating a square wave at a specific frequency for a specific duration. The system was able to play Für Elise by Beethoven and Faded by Alan Walker as part of testing the functionality.</p>
</section>
<section id="experiment-setup-and-design-overview" class="level2">
<h2 class="anchored" data-anchor-id="experiment-setup-and-design-overview">Experiment Setup and Design Overview</h2>
<p>The main purpose of the lab was to learn how to read the manual and figure out how to set up different peripherals and the I/O of the MCU to perform the desired function. This includes initializing the proper structures and logic which are essential to run functions and extract performance out of the MCU. The MCU was set up to read a program containing a list of notes (shown as their frequency in Hz) and duration (shown in ms) to play the desired music.</p>
<section id="mcu-setup-logic" class="level3">
<h3 class="anchored" data-anchor-id="mcu-setup-logic">MCU Setup Logic</h3>
<p>To set up the MCU for the desired function, we had to configure different modules to run the system clock, set up timers, pre-flash functions, and configure the GPIO to use. To do this, we had to set up respective Header files to interface these functionalities. The header files setup were: <code>RCC.h</code>,the Reset &amp; Clock Control (RCC) module to set up the system clock; <code>GPIO.h</code>, used to configure GPIO functions and enable parameters for other peripherals and <code>TIM6_7.h</code>, used to setup and configure parameters for the basic timers.</p>
<p>The MCU features timers that have specific channels for PWM generation (<code>TIM2, TIM3, TIM15, &amp; TIM16</code>). They can be configured for PWM using output compare mode (CCR) and different prescaler values and auto-reload settings (ARR) to set up PWM frequencies and duty cycle. This approach was a challenge for me in terms of configuring the relevant registers and structures to perform PWM on <code>TIM15</code> or <code>TIM16</code> properly. The major issue is that if one bit is configured wrong, it renders a register useless, and this will yield no output on the circuit; it was hard for me to debug even with an oscilloscope. I elected to use the basic timers <code>TIM6 and TIM7</code> to perform the tasks for this lab, which was simpler as I had full control over the behaviour of the counters. The main idea was to configure each timer’s prescaler and <code>ARR</code> so that the counters overflow at predictable intervals and then constantly check the timer’s status register (SR) for when the <code>UIF</code> bit is set. For delays, <code>TIM6</code> runs until it overflows at the desired duration, at which point the UIF is cleared to acknowledge completion. For PWM generation, <code>TIM7</code> is configured to overflow at half of the desired wave period, which is used to time each high- and low-phase of the square wave.</p>
</section>
<section id="implementation" class="level3">
<h3 class="anchored" data-anchor-id="implementation">Implementation</h3>
<p>Each timer is driven by the system clock (4MHz) and is divided using the AHB prescaler down to 1MHz to set the peripheral clock (HCLK) for all timers, following the equation below:</p>
<p><span id="eq-HCLK"><span class="math display">\[
\text{HCLK} = \frac{\text{SYSCLK}}{\text{AHB Factor}} = \frac{\text{4MHz}}{4} = \text{1MHz}
\tag{1}\]</span></span></p>
<p>The HCLK was further divided down to set the counter frequency of <code>TIM6</code> to 1kHz, meaning that each tick was exactly 1ms. This scaling allowed me to implement the delay functionality by setting <code>ARR = dur – 1</code>, where dur is the desired frequency duration, and waiting until the UIF flag is raised. <code>TIM6</code> count frequency was obtained by setting <code>TIM6</code> prescaler (PSC) to <code>PSC = 999</code> as shown below:</p>
<p><span id="eq-DelayFreq"><span class="math display">\[
f_\text{TIM6} = \frac{\text{HCLK}}{(\text{PSC}+1)} = \frac{\text{1MHz}}{(999+1)} = \text{1kHz}
\tag{2}\]</span></span></p>
<p>For PWM generation, both <code>TIM6</code> and <code>TIM7</code> are used together. <code>TIM6</code> measures the total pulse duration by overflowing after <code>dur</code> milliseconds. Since we configured <code>TIM7</code> to drive a PWM output in toggle mode, the hardware toggles the output every overflow. This means that the output signal is two overflows long (one rising and one falling edge). Therefore, to generate the desired frequency, <code>TIM7</code> is configured to overflow every half-period of the desired frequency (run at twice the desired frequency), given a 1MHz timer frequency as shown below:</p>
<p><span id="eq-WaveFreq"><span class="math display">\[
T_\text{half} = \frac{1}{2f_\text{PWM}} = \frac{1,000,000}{2 f_\text{PWM}} \text{µs}
\tag{3}\]</span></span></p>
<p>This is used to time each high- and low-phase of the square wave. Inside the PWM loop, the GPIO pin is driven high for one half-period, then low for the next half-period, with each phase timed by constantly checking UIF on <code>TIM7</code>, the wave timer. The process continues until UIF on <code>TIM6</code> indicates that the total duration has expired. Suppose the overall delay timer finishes in the middle of a PWM cycle. In that case, the code breaks out instead of doing another half-period, essentially handling one of the edge cases in PWM generation. Also, the UIF bit is cleared after each wait, ensuring the next period is measured accurately.</p>
<p>This logic avoids system interrupts because the UIF is polled directly, allowing all control to be done in software. This keeps the CPU busy through wait loops, limiting it to only one function, as this also makes debugging easier. This works for this lab, as the CPU doesn’t need to perform any other functions simultaneously or otherwise, I would have to use interrupts.</p>
</section>
</section>
<section id="verification-of-timer-limits-and-edge-cases" class="level2">
<h2 class="anchored" data-anchor-id="verification-of-timer-limits-and-edge-cases">Verification of Timer Limits and Edge Cases</h2>
<section id="delay-limits" class="level3">
<h3 class="anchored" data-anchor-id="delay-limits">Delay Limits</h3>
<p>The delay timer, <code>TIM6</code>, runs at a counter frequency of <span class="math inline">\(1kHz\)</span>, where one tick is equivalent to <span class="math inline">\(1ms\)</span>. The overflow period for the timer is obtained through:</p>
<p><span id="eq-Delay"><span class="math display">\[
t_\text{delay} = \frac{(ARR + 1)}{f_\text{TIM6}}
\tag{4}\]</span></span></p>
<ul>
<li>The <strong><em>minimum delay</em></strong> can only be achieved when <code>ARR = 0</code> since it can never be negative. Therefore:</li>
</ul>
<p><span id="eq-MinDelay"><span class="math display">\[
t_\text{delay} = \frac{(0 + 1)}{\text{1kHz}} = 1ms
\tag{5}\]</span></span></p>
<ul>
<li>TIM6 has a 16-bit counter, therefore <strong><em>maximum delay</em></strong> can only be achieved when <code>ARR = 65,535</code>. Therefore:</li>
</ul>
<p><span id="eq-MaxDelay"><span class="math display">\[
t_\text{delay} = \frac{(65535 + 1)}{\text{1kHz}} = 65.536s
\tag{6}\]</span></span></p>
<p>With a counter frequency of <span class="math inline">\(1 kHz\)</span>, <code>TIM6</code> supports a duration within the range of <strong>1 ms</strong> to <strong>65.536 s</strong>, with <strong>1 ms</strong> resolution, which is more than enough for the desired application in this lab.</p>
</section>
<section id="pwm-frequency-limits" class="level3">
<h3 class="anchored" data-anchor-id="pwm-frequency-limits">PWM Frequency Limits</h3>
<p>The PWM wave timer, <code>TIM7</code>, runs at HCLK which is <span class="math inline">\(1MHz\)</span> and is toggled on each overflow. As mentioned before in the <a href="#implementation">Implementation</a> section above, <code>TIM7</code> has to toggle at twice the desired rate to ensure the output square wave comes out as desired. The frequency of the toggled square wave is determined by <a href="#eq-toggle" class="quarto-xref">Equation&nbsp;7</a> below:</p>
<p><span id="eq-toggle"><span class="math display">\[
f_\text{PWM} = \frac{\text{HCLK}}{2(ARR + 1)}
\tag{7}\]</span></span></p>
<ul>
<li><a href="#eq-toggle" class="quarto-xref">Equation&nbsp;7</a> above shows that the PWM frequency is inversely proportional to <code>ARR</code>. Therefore <strong><em>minimum toggle frequency</em></strong> exists at the maximum possible <code>ARR</code> value, <code>ARR = 65,535</code>. Therefore:</li>
</ul>
<p><span id="eq-Mintoggle"><span class="math display">\[
f_\text{PWM} = \frac{1,000,000}{2(65535 + 1)} = 7.629Hz
\tag{8}\]</span></span></p>
<ul>
<li>Following similar logic, <strong><em>maximum toggle frequency</em></strong> exists at the minimum possible <code>ARR</code> value, <code>ARR = 0</code>. Therefore:</li>
</ul>
<p><span id="eq-Maxtoggle"><span class="math display">\[
f_\text{PWM} = \frac{1,000,000}{2(0 + 1)} = 500kHz
\tag{9}\]</span></span></p>
<p>With a timer frequency of <span class="math inline">\(1MHz\)</span>, <code>TIM7</code> supported frequencies range calculated above encompasses the desired frequency range of <strong>220Hz</strong> to <strong>1000Hz</strong> sufficient for our applications.</p>
</section>
<section id="song-playing-accuracy" class="level3">
<h3 class="anchored" data-anchor-id="song-playing-accuracy">Song Playing Accuracy</h3>
<p>The durations were pretty much accurate because <code>TIM6</code> was confugured with a period in milliseconds. The desired duration was directly equivalent to the <code>ARR</code> used in <a href="#eq-Delay" class="quarto-xref">Equation&nbsp;4</a>. The ARR input into the equation was calculated using the equation below:</p>
<p><span id="eq-DelayCalc"><span class="math display">\[
\text{ARR} = \text{duration} - 1
\tag{10}\]</span></span></p>
<p>This meant that going into calculations the period divider was equivalent to the actual millisecond delay desired.</p>
<p>For the frequencies, the ARR input into <code>TIM7</code> was calculated using the half-frequency division to allow running both rising and falling edges of the square wave within the timing window set by the delay. It was obtained using the following equation:</p>
<p><span id="eq-FreqCalc"><span class="math display">\[
\text{ARR} = \frac{\text{HCLK}}{2f_\text{PWM}} - 1
\tag{11}\]</span></span></p>
<ul>
<li>If the desired frequency was <strong>220Hz</strong> then, <a href="#eq-FreqCalc" class="quarto-xref">Equation&nbsp;11</a> gives <span class="math inline">\(ARR\approx 2272\)</span>. Substituting this in <a href="#eq-toggle" class="quarto-xref">Equation&nbsp;7</a> gives toggle frequency, <span class="math inline">\(f_\text{toggle} = 219.97Hz\)</span>, equivalent to a <strong>0.014% error</strong>.</li>
<li>If the desired frequency was <strong>1000Hz</strong> then, <a href="#eq-FreqCalc" class="quarto-xref">Equation&nbsp;11</a> gives <span class="math inline">\(ARR\approx 499\)</span>. Substituting this in <a href="#eq-toggle" class="quarto-xref">Equation&nbsp;7</a> gives toggle frequency, <span class="math inline">\(f_\text{toggle} = 1000Hz\)</span>, equivalent to a <strong>0.00% error</strong>.</li>
</ul>
<p>This proves that individual pitches are accurate within 1% across the frequency range of 220-1000 Hz as desired, therefore verifying precision and accuracy of the design.</p>
</section>
</section>
<section id="hardware-testing-and-results" class="level2">
<h2 class="anchored" data-anchor-id="hardware-testing-and-results">Hardware Testing and Results</h2>
<p>After verifying the MCU logic, the code was uploaded on the hardware for testing using Segger Embedded Studio. The setup used onboard switches connected to pins <code>A7</code> and <code>A4</code> of the MCU. These pins were used to switch between the two available songs. The switches were configured by activating the onboard <span class="math inline">\(10k\Omega\)</span> pull-up resistors through the dedicated <code>PURPDR</code> GPIO function. The MCU toggle output through pin <code>A7</code> was fed into a <span class="math inline">\(10k\Omega\)</span> potentiometer for volume control, which sent it to the non-inverting input of the LM386 op-amp. The ouput of the op-amp (analog signal) went to the speaker to play the chosen song. All components were collected and assembled on an extended breadboard following the schematic below:</p>
<div id="fig-Lab4Schematic" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Lab4Schematic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/lab4Schematic.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Lab4Schematic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: MCU Experiment Wiring Setup
</figcaption>
</figure>
</div>
<p>The hardware responded properly as shown in the example video below:</p>
<div id="fig-Demo" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Demo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<video src="images/lab4Demo.mp4" class="img-fluid" controls=""><a href="images/lab4Demo.mp4">Video</a></video>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Demo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Hardware Execution Example Playing Songs and Adjusting Volume
</figcaption>
</figure>
</div>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>This lab took around 19 hours to complete. A lot of time was spent figuring out how to set up the proper registers for timers as well as other functions I epected to use with my MCU. It was also hard to debug since unlike the FPGA, when anything is wrong, you don’t get any output which is different from the FPGA where you get a wrong output and could debug from there. The errors I found were through register instantiation and some typos like negative signs in the implementation that were not caught by the compiler. Resolving all of this allowed me to get my hardware playing music properly.</p>
</section>
<section id="ai-prototype-summary" class="level2">
<h2 class="anchored" data-anchor-id="ai-prototype-summary">AI Prototype Summary</h2>
<p>The goal of this prototype is using AI as a documentation search assistant to navigate memory maps and guide the configuration of various peripherals. I used Chatgpt 5 to run the different prompts and it gave me the following results:</p>
<ol type="1">
<li>The AI was able to recognisze the different types of registers that could be used, identified the pros and cons of using either, and also managed to predict the full course all the way from instantiating registers to implementing CCR, prescaler, and ARR functionality. However this was after I passed the STM32L4 reference manual along with the prompt. <a href="#fig-timers" class="quarto-xref">Figure&nbsp;3</a> below shows this initial realization:</li>
</ol>
<div id="fig-timers" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-timers-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/AIPrototype/Timers.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-timers-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Example Timers Identified by The LLM.
</figcaption>
</figure>
</div>
<ol start="2" type="1">
<li>After Identifying potential timers to use for the desired PWM generation, the LLM also correctly identified how to calculate the ARR, frequency, duty cycle, and necessary prescalers to perform the functions. <a href="#fig-TIMSetup" class="quarto-xref">Figure&nbsp;4</a> below shows this implementation:</li>
</ol>
<div id="fig-TIMSetup" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-TIMSetup-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/AIPrototype/TIMSetup.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-TIMSetup-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Explanations and Calculations Necessary to Find Parameters of the PWM.
</figcaption>
</figure>
</div>
<ol start="3" type="1">
<li>After correctly identifying the timers, the LLM went on to initalize all the necessary registers in proper steps. <a href="#fig-registerSetup" class="quarto-xref">Figure&nbsp;5</a> below shows this implementation:</li>
</ol>
<div id="fig-registerSetup" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-registerSetup-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/AIPrototype/registerSetup.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-registerSetup-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Register Instantiation for GP Timers TIM2/TIM3.
</figcaption>
</figure>
</div>
<ol start="4" type="1">
<li>Here is also an example provided to show the use of the different register declarations. This shows me that the LLM got the idea on what to do and how to setup to achieve the desired frequency RPM and durations as shown in <a href="#fig-Example" class="quarto-xref">Figure&nbsp;6</a> below:</li>
</ol>
<div id="fig-Example" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/AIPrototype/Example.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Example ARR and PRSC values Calculation.
</figcaption>
</figure>
</div>
<ol start="5" type="1">
<li>Lastly, the LLM provided an example code to show how it could drive the pins to generate a frequency. The code enables timers, configures GPIO, ARR and Prescalers, the code also implements a ms delay function to ensure separation between different frequencies driven.</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Simple PWM tone generator on STM32L432KC</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Output: PA0 = TIM2_CH1 (AF1)</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Freq range: 220 Hz – 1 kHz (works for others too)</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Toolchain: bare-metal with CMSIS headers</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"stm32l4xx.h"</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#define TIM2CLK_HZ   </span><span class="dv">80000000</span><span class="bu">UL</span><span class="pp">   </span><span class="co">// Adjust if your clock tree differs</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#define TARGET_TICK  </span><span class="dv">1000000</span><span class="bu">UL</span><span class="pp">    </span><span class="co">// We prescale timer to 1 MHz for easy math (1 tick = 1 us)</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span> tim2_set_freq<span class="op">(</span><span class="dt">uint32_t</span> freq_hz<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>freq_hz <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Stop output</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>        TIM2<span class="op">-&gt;</span>CCER <span class="op">&amp;=</span> <span class="op">~</span>TIM_CCER_CC1E<span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// With timer tick at 1 MHz, ARR = (1e6 / f) - 1</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> arr <span class="op">=</span> <span class="op">(</span>TARGET_TICK <span class="op">/</span> freq_hz<span class="op">)</span> <span class="op">-</span> <span class="dv">1</span><span class="bu">U</span><span class="op">;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>arr <span class="op">&lt;</span> <span class="dv">1</span><span class="op">)</span> arr <span class="op">=</span> <span class="dv">1</span><span class="op">;</span>  <span class="co">// guard</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use 50% duty: CCR1 = (ARR+1)/2</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> ccr <span class="op">=</span> <span class="op">(</span>arr <span class="op">+</span> <span class="dv">1</span><span class="bu">U</span><span class="op">)</span> <span class="op">/</span> <span class="dv">2</span><span class="bu">U</span><span class="op">;</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update safely using preload + UG</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    TIM2<span class="op">-&gt;</span>ARR  <span class="op">=</span> arr<span class="op">;</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    TIM2<span class="op">-&gt;</span>CCR1 <span class="op">=</span> ccr<span class="op">;</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    TIM2<span class="op">-&gt;</span>EGR  <span class="op">=</span> TIM_EGR_UG<span class="op">;</span>     <span class="co">// latch PSC/ARR/CCR</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co">// crude delay</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> delay_ms<span class="op">(</span><span class="dt">uint32_t</span> ms<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ~4 cycles per loop at -O2 on Cortex-M4F; tweak if needed</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For simplicity, use a coarse busy wait:</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">volatile</span> <span class="dt">uint32_t</span> n <span class="op">=</span> ms <span class="op">*</span> <span class="dv">16000</span><span class="bu">UL</span><span class="op">;</span> <span class="co">// assuming 64–80 MHz core; it's okay if approximate</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>n<span class="op">--)</span> __NOP<span class="op">();</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// --- 1) Enable clocks ---</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    RCC<span class="op">-&gt;</span>AHB2ENR  <span class="op">|=</span> RCC_AHB2ENR_GPIOAEN<span class="op">;</span>       <span class="co">// GPIOA clock</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    RCC<span class="op">-&gt;</span>APB1ENR1 <span class="op">|=</span> RCC_APB1ENR1_TIM2EN<span class="op">;</span>       <span class="co">// TIM2 clock</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// --- 2) Configure PA0 as AF1 (TIM2_CH1) ---</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// PA0: MODER=10 (AF), AFRL0=0001 (AF1), push-pull, high speed</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    GPIOA<span class="op">-&gt;</span>MODER   <span class="op">=</span> <span class="op">(</span>GPIOA<span class="op">-&gt;</span>MODER <span class="op">&amp;</span> <span class="op">~(</span><span class="dv">3</span><span class="bu">U</span> <span class="op">&lt;&lt;</span> <span class="op">(</span><span class="dv">0</span><span class="op">*</span><span class="dv">2</span><span class="op">)))</span> <span class="op">|</span> <span class="op">(</span><span class="dv">2</span><span class="bu">U</span> <span class="op">&lt;&lt;</span> <span class="op">(</span><span class="dv">0</span><span class="op">*</span><span class="dv">2</span><span class="op">));</span> <span class="co">// AF</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>    GPIOA<span class="op">-&gt;</span>AFR<span class="op">[</span><span class="dv">0</span><span class="op">]</span>  <span class="op">=</span> <span class="op">(</span>GPIOA<span class="op">-&gt;</span>AFR<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">&amp;</span> <span class="op">~(</span><span class="bn">0xF</span><span class="bu">U</span> <span class="op">&lt;&lt;</span> <span class="op">(</span><span class="dv">0</span><span class="op">*</span><span class="dv">4</span><span class="op">)))</span> <span class="op">|</span> <span class="op">(</span><span class="dv">1</span><span class="bu">U</span> <span class="op">&lt;&lt;</span> <span class="op">(</span><span class="dv">0</span><span class="op">*</span><span class="dv">4</span><span class="op">));</span> <span class="co">// AF1</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    GPIOA<span class="op">-&gt;</span>OSPEEDR <span class="op">|=</span> <span class="op">(</span><span class="dv">3</span><span class="bu">U</span> <span class="op">&lt;&lt;</span> <span class="op">(</span><span class="dv">0</span><span class="op">*</span><span class="dv">2</span><span class="op">));</span>   <span class="co">// high speed (optional)</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    GPIOA<span class="op">-&gt;</span>OTYPER  <span class="op">&amp;=</span> <span class="op">~(</span><span class="dv">1</span><span class="bu">U</span> <span class="op">&lt;&lt;</span> <span class="dv">0</span><span class="op">);</span>      <span class="co">// push-pull</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    GPIOA<span class="op">-&gt;</span>PUPDR   <span class="op">&amp;=</span> <span class="op">~(</span><span class="dv">3</span><span class="bu">U</span> <span class="op">&lt;&lt;</span> <span class="op">(</span><span class="dv">0</span><span class="op">*</span><span class="dv">2</span><span class="op">));</span>  <span class="co">// no pull (or set to taste)</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">// --- 3) Configure TIM2 base to 1 MHz tick ---</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">// PSC = TIM2CLK/TARGET_TICK - 1 -&gt; 80 MHz / 1 MHz - 1 = 79</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    TIM2<span class="op">-&gt;</span>CR1   <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>                   <span class="co">// upcount, edge-aligned</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>    TIM2<span class="op">-&gt;</span>PSC   <span class="op">=</span> <span class="op">(</span>TIM2CLK_HZ <span class="op">/</span> TARGET_TICK<span class="op">)</span> <span class="op">-</span> <span class="dv">1</span><span class="bu">U</span><span class="op">;</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    TIM2<span class="op">-&gt;</span>ARR   <span class="op">=</span> <span class="dv">999</span><span class="op">;</span>                 <span class="co">// placeholder (1 kHz initially)</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    TIM2<span class="op">-&gt;</span>CCR1  <span class="op">=</span> <span class="dv">500</span><span class="op">;</span>                 <span class="co">// 50% duty</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">// PWM mode 1 on CH1 + preload</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">// OC1M = 110 (bits 6:4), OC1PE=1 (bit 3)</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>    TIM2<span class="op">-&gt;</span>CCMR1 <span class="op">&amp;=</span> <span class="op">~((</span><span class="dv">7</span><span class="bu">U</span> <span class="op">&lt;&lt;</span> <span class="dv">4</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="dv">1</span><span class="bu">U</span> <span class="op">&lt;&lt;</span> <span class="dv">3</span><span class="op">));</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    TIM2<span class="op">-&gt;</span>CCMR1 <span class="op">|=</span>  <span class="op">(</span><span class="dv">6</span><span class="bu">U</span> <span class="op">&lt;&lt;</span> <span class="dv">4</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="dv">1</span><span class="bu">U</span> <span class="op">&lt;&lt;</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Enable output on CH1 (active-high)</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    TIM2<span class="op">-&gt;</span>CCER  <span class="op">&amp;=</span> <span class="op">~((</span><span class="dv">1</span><span class="bu">U</span><span class="op">&lt;&lt;</span><span class="dv">1</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="dv">1</span><span class="bu">U</span><span class="op">&lt;&lt;</span><span class="dv">3</span><span class="op">));</span> <span class="co">// CC1P=0, CC1NP=0</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    TIM2<span class="op">-&gt;</span>CCER  <span class="op">|=</span>  <span class="op">(</span><span class="dv">1</span><span class="bu">U</span><span class="op">&lt;&lt;</span><span class="dv">0</span><span class="op">);</span>             <span class="co">// CC1E=1</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Enable ARR preload and latch settings</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    TIM2<span class="op">-&gt;</span>CR1   <span class="op">|=</span> TIM_CR1_ARPE<span class="op">;</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>    TIM2<span class="op">-&gt;</span>EGR    <span class="op">=</span> TIM_EGR_UG<span class="op">;</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">// --- 4) Start timer ---</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>    TIM2<span class="op">-&gt;</span>CR1   <span class="op">|=</span> TIM_CR1_CEN<span class="op">;</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>    <span class="co">// --- Demo: cycle a few musical-ish tones ---</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>        tim2_set_freq<span class="op">(</span><span class="dv">220</span><span class="op">);</span>  <span class="co">// A3</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>        delay_ms<span class="op">(</span><span class="dv">800</span><span class="op">);</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>        tim2_set_freq<span class="op">(</span><span class="dv">440</span><span class="op">);</span>  <span class="co">// A4</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>        delay_ms<span class="op">(</span><span class="dv">800</span><span class="op">);</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>        tim2_set_freq<span class="op">(</span><span class="dv">880</span><span class="op">);</span>  <span class="co">// A5</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>        delay_ms<span class="op">(</span><span class="dv">800</span><span class="op">);</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>        tim2_set_freq<span class="op">(</span><span class="dv">1000</span><span class="op">);</span> <span class="co">// 1 kHz</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>        delay_ms<span class="op">(</span><span class="dv">800</span><span class="op">);</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The code provided seems resonable to me. It configures TIM2 for PWM generation, same way I could have done with TIM15. It calls the necessary structures such as <code>CR1, CCR, PSC, and ARR</code>. The code compiles of course except for some specific variables the LLM probably defined in the assumed <strong>stm32l4xx.h</strong> header file. I didn’t test the code on hardware, but from what I analyzed so far I believe it works well. The LLM also uses the crude delay with the assembly <code>__nop</code> function.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/Rex-Josaphat\.github\.io\/E155-Portfolio\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>